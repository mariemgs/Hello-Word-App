name: "CI/CD Pipeline - Build and Deploy to Azure"

on:
  push:
    branches: 
      - "main"
  pull_request:
    branches: 
      - "main"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4

    - name: "Log in to Docker Hub"
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: "Build Docker image"
      run: |
        docker build -t mariemguesmi/flask-hello:${{ github.sha }} .
        docker tag mariemguesmi/flask-hello:${{ github.sha }} mariemguesmi/flask-hello:latest

    - name: "Push Docker image"
      run: |
        docker push mariemguesmi/flask-hello:${{ github.sha }}
        docker push mariemguesmi/flask-hello:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: "Log in to Azure"
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: "Deploy to Azure Web App"
      uses: azure/webapps-deploy@v2
      with:
        app-name: "Hello-Word-App"
        slot-name: "production"
        resource-group-name: "mariem"
        images: "mariemguesmi/flask-hello:latest"